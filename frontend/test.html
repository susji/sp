<html>
  <head>
    <script type="module">
      import { encryptMessage, decryptMessage, generateKey,
	       StringToArray, ObjectToArray } from "./sp.js";

      const setEncryptionResult = function (enc, iv) {
	  const i = btoa(JSON.stringify(iv));
	  const e = btoa(String.fromCharCode(...new Uint8Array(enc)));
	  const comb = i + "|" + e;
	  document.getElementById("encryption-result").value = comb;
      }

      const getEncryptionResult = function () {
	  const parts = document
		.getElementById("encryption-result")
		.value
		.split("|", 2);
	  const i = JSON.parse(atob(parts[0]));
	  const e = Uint8Array.from(StringToArray(atob(parts[1])));
	  console.log("getEncryptionResult: ", i, e);
	  return {
	      iv: i,
	      ciphertext: e
	  }
      }

      const setEncryptionSecret = function (key) {
	  window.top.location.hash = btoa(JSON.stringify(key));
      }

      const getEncryptionSecret = function () {
	  return JSON.parse(atob(window.top.location.hash.substr(1)));
      }

      const setDecryptionResult = function (plaintext) {
	  document.getElementById("message-decrypted").value = plaintext;
      }

      window.getPlaintext = function () {
	  return document.getElementById("message-to-encrypt").value
      }

      window.getCiphertext = getEncryptionResult;
      window.scrambleSecret = async function () {
	  const key = await window.crypto.subtle.exportKey("jwk", await generateKey());
	  setEncryptionSecret(key);
      }

      window.doEncrypt = async function (msg) {
	  console.log("[encrypt]");
	  const res = await encryptMessage(msg);

	  setDecryptionResult("");
	  setEncryptionResult(res.ciphertext, res.iv);
	  setEncryptionSecret(res.key);
      }
      window.doDecrypt = async function (msg) {
	  console.log("[decrypt]");
	  const key = getEncryptionSecret();
	  const res = getEncryptionResult();
	  setDecryptionResult("");

	  const iv = Uint8Array.from(ObjectToArray(res.iv));
	  try {
	      const plaintext = await decryptMessage(
		  res.ciphertext,
		  key,
		  iv);
	      setDecryptionResult(new TextDecoder().decode(plaintext));
	  } catch (err) {
	      console.log("Decryption failed: ", err);
	  }
      }
    </script>
  </head>
  <body>
    <div>
      <form onsubmit="event.preventDefault(); doEncrypt(getPlaintext());">
	<textarea
	  id="message-to-encrypt"
	  placeholder="Insert text for encryption here.">Hello World!</textarea>
	<input type="submit" value="Encrypt">
      </form>
    </div>

    <div>
      Result blob: <textarea
		     id="encryption-result"
		     placeholder="Press 'Encrypt'."
		     readonly></textarea>
      <input type="button" onclick="scrambleSecret()" value="Scramble secret">
    </div>

    <div>
      <form onsubmit="event.preventDefault(); doDecrypt(getCiphertext());">
	<textarea
	  id="message-decrypted"
	  placeholder="Press 'Decrypt'."
	  readonly></textarea>
	<input type="submit" value="Decrypt">
      </form>
    </div>
  </body>
</html>
